<!DOCTYPE html>
<html>
<head>
    <title>Othello (Multiplayer)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        #board { display: grid; grid-template-columns: repeat(8, 50px); gap: 2px; margin: 20px 0; }
        .cell { 
            width: 50px; height: 50px; 
            background-color: #2e8b57; 
            display: flex; justify-content: center; 
            align-items: center; cursor: pointer;
        }
        .stone { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #333; }
        .black { background-color: #222; }
        .white { background-color: #fff; }
        .legal-move { box-shadow: inset 0 0 0 3px yellow; }
        #status { font-size: 1.2em; margin: 10px 0; }
        #game-controls { margin: 20px 0; }
        input, button { padding: 8px; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="game-controls">
       
        <select id="ai-level">
            <option value="3" selected>Level 3 (Easy)</option>
            <option value="4">Level 4 (Medium)</option>
            <option value="5">Level 5 (Hard)</option>
        </select>
        <button id="start-ai-game">Start vs AI</button>
    
        <button id="create-room">Create Room</button>
        <input id="room-id" placeholder="Room ID">
        <button id="join-room">Join Room</button>
    </div>
    <div id="status">Waiting to join game...</div>
    
    <div id="score" style="font-size:1.2em; margin:10px 0;"></div>

    <div id="board"></div>

    <script>
        const socket = io();
        let currentGameId = null;
        let playerId = 'player-' + Math.random().toString(36).substring(2, 9);
        let yourColor = null;  // -1 が黒、1 が白

        // 初期化
        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    board.appendChild(cell);
                }
            }
        }
        
        // ８方向ベクトル
        const directions = [
            {dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},
            {dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}
        ];

        // 合法手計算
        function computeLegalMoves(board, color) {
            const opponent = -color;
            const moves = [];
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    if (board[y][x] !== 0) continue;
                    for (const {dx,dy} of directions) {
                        let nx = x + dx, ny = y + dy;
                        let hasOpp = false;
                        while (0 <= nx && nx < 8 && 0 <= ny && ny < 8 && board[ny][nx] === opponent) {
                            hasOpp = true; nx += dx; ny += dy;
                        }
                        if (hasOpp && 0 <= nx && nx < 8 && 0 <= ny && ny < 8 && board[ny][nx] === color) {
                            moves.push({x, y});
                            break;
                        }
                    }
                }
            }
            return moves;
        }

        // 盤面更新
        function updateBoard(board, turn) {
            // Clear the board first
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerHTML = '';
                cell.classList.remove('legal-move');
                cell.onclick = null;
            });

            // Draw stones
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const cell = document.querySelector(`.cell[data-row="${y}"][data-col="${x}"]`);
                    if (board[y][x] === -1 || board[y][x] === 1) {
                        const stone = document.createElement('div');
                        stone.className = `stone ${board[y][x] === -1 ? 'black' : 'white'}`;
                        cell.appendChild(stone);
                    }
                }
            }

    // Highlight legal moves if it's our turn
    if (yourColor !== null && turn === yourColor) {
        const legalMoves = computeLegalMoves(board, yourColor);
        legalMoves.forEach(move => {
            const cell = document.querySelector(`.cell[data-row="${move.y}"][data-col="${move.x}"]`);
            cell.classList.add('legal-move');
            cell.onclick = () => makeMove(move.y, move.x);
        });
    }
}

        // 手を打つ
        function makeMove(row, col) {
            if (!currentGameId) {
                alert('Please join a game first!');
                return;
            }
            socket.emit('make_move', {
                game_id: currentGameId,
                player_id: playerId,
                row, col
            });
        }

        // イベントリスナー
        
        // Modify the "Start vs AI" button handler
　　document.getElementById('start-ai-game').addEventListener('click', () => {
    const level = parseInt(document.getElementById('ai-level').value, 10);
    const gameId = document.getElementById('room-id').value.trim();
    
    // Reset game state
    yourColor = null;
    currentGameId = null;
    
    socket.emit('start_ai_game', {
        level: level,
        game_id: gameId,
        player_id: playerId  // Send our playerId
    });
});

        // Update the 'joined' handler
        / Update the 'joined' handler
        socket.on('joined', (data) => {
            console.log("JOINED DATA:", data);
            yourColor = data.your_color;  // Should be -1 for human in AI mode
            currentGameId = data.game_id;
            
            const me = data.players.find(p => p.id === playerId);
            const opp = data.players.find(p => p.id !== playerId);
            
            document.getElementById('status').textContent = 
                `You (Black) vs Computer (White) | Turn: ${data.turn === -1 ? 'Black (Your move)' : 'White'}`;
            
            initBoard();
            updateBoard(data.board, data.turn);
            
            // Debug output
            console.log("Your color:", yourColor, "Current turn:", data.turn);
       
        
        // Include playerId in the emit
        socket.emit('start_ai_game', {
            level: level,
            game_id: gameId,
            player_id: playerId  // Make sure to send our playerId
        });
    });
         
         
         

        // サーバーから新しく作成した部屋IDを受け取る
        // サーバーから部屋が作成されたときのイベント
        socket.on('room_created', data => {
        console.log("Room created:", data.game_id);
        document.getElementById('room-id').value = data.game_id;
        currentGameId = data.game_id;  // ここでグローバル変数を更新
        });


        socket.on('game_started', data => {
        console.log("Game started event received:", data);
        // もし data に game_id が含まれていれば、グローバル変数を更新
        if (data.game_id) {
            document.getElementById('room-id').value = data.game_id;
            currentGameId = data.game_id;
        }
        updateBoard(data.board);  // 盤面描画関数を呼ぶ
        document.getElementById('status').textContent =
            `Turn: ${data.turn === -1 ? 'Black' : 'White'}`;
        });




        document.getElementById('create-room').addEventListener('click', () => {
            fetch('/create_room')
                .then(res => res.json())
                .then(data => {
                    currentGameId = data.game_id;
                    document.getElementById('room-id').value = data.game_id;
                    socket.emit('join_game', {
                        game_id: data.game_id,
                        player_id: playerId,
                        name: 'Player-' + playerId.substring(7)
                    });
                    document.getElementById('status').textContent = 'Room created. Waiting for opponent...';
                });
        });

        document.getElementById('join-room').addEventListener('click', () => {
            const roomId = document.getElementById('room-id').value.trim();
            if (!roomId) return alert('Please enter a Room ID');
            currentGameId = roomId;
            socket.emit('join_game', {
                game_id: roomId,
                player_id: playerId,
                name: 'Player-' + playerId.substring(7)
            });
            document.getElementById('status').textContent = 'Joining game...';
        });

        /// Update the 'joined' event handler
    socket.on('joined', (data) => {
    console.log("JOINED:", data);
    yourColor = data.your_color;  // This should be -1 for human in AI mode
    
    const me = data.players.find(p => p.id === playerId);
    const opp = data.players.find(p => p.id !== playerId);
    
    const meName = me ? me.name : 'You';
    const oppName = opp ? opp.name : 'Waiting...';
    const meColor = yourColor === -1 ? 'Black' : 'White';
    
    document.getElementById('status').textContent =
        `${meName} (${meColor}) vs ${oppName} | Turn: ${data.turn === -1 ? 'Black' : 'White'}`;
    
    initBoard();
    updateBoard(data.board, data.turn);
    
    // Debug output
    console.log("Your color:", yourColor, "Current turn:", data.turn);
    console.log("Legal moves:", computeLegalMoves(data.board, yourColor));
    });

    // Update the 'game_state' handler
    socket.on('game_state', (data) => {
    console.log("GAME_STATE:", data);
    updateBoard(data.board, data.turn);

    let statusText;
    if (data.status === 'game_over') {
        const w = data.score.white;
        const b = data.score.black;
        statusText = `Game Over — White: ${w}, Black: ${b}`;
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('legal-move'));
    } else {
        const turnText = data.turn === -1 ? 'Black' : 'White';
        statusText = `Turn: ${turnText}`;
        if (yourColor !== null && data.turn === yourColor) {
            statusText += ' (Your move)';
        }
    }
    document.getElementById('status').textContent = statusText;

    // Update score display
    const scoreEl = document.getElementById('score');
    if (data.status === 'game_over') {
        scoreEl.textContent = `Final Score — White: ${data.score.white}, Black: ${data.score.black}`;
    } else {
        scoreEl.textContent = '';
    }
    });

        // 初期描画
        initBoard();
    </script>
</body>
</html>
