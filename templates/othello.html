<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>オセロゲーム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    table {
      border-collapse: collapse;
      margin: 20px auto;
      background: #2e8b57; /* 緑色の盤面 */
    }
    td {
    width: 60px;
    height: 60px;
    border: 2px solid #000;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    position: relative;   /* 石を絶対配置するために追加 */
  }
  td.black::before,
  td.white::before {
    content: "";
    display: block;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  td.black::before {
    background: #000;
    box-shadow: inset 0 0 0 2px #fff;
  }
  td.white::before {
    background: #fff;
    box-shadow: inset 0 0 0 2px #000;
  }

  </style>
</head>
<body>
  <h1>オセロゲーム</h1>
  <div>
    <strong>現在の手番:</strong>
    <!-- サーバーサイド描画部分（初回のみ使用、以降は JavaScript で更新） -->
    <span id="currentTurn" style="color: {% if turn == -1 %}black{% else %}gray{% endif %}">
      {% if turn == -1 %}黒 ●{% elif turn == 1 %}白 ○{% endif %}
    </span>
  </div>
  <button onclick="resetBoard()">ゲームをリセット</button>
  <table>
    {% for i in range(8) %}
      <tr>
      {% for j in range(8) %}
        <td
          onclick="sendMove({{ i }}, {{ j }})"
          class="{% if board[i][j] == 1 %}white{% elif board[i][j] == -1 %}black{% else %}{% endif %}"
        >
          {% if board[i][j] == -1 %}
            ●
          {% elif board[i][j] == 1 %}
            ○
          {% endif %}
        </td>
      {% endfor %}
      </tr>
    {% endfor %}
  </table>
  

    <!-- 既存の <script>…</script> をまるっと置き換え -->
    <script>
      // サーバーから返ってくる盤面を描画する関数
      function updateBoardUI(board) {
      const table = document.querySelector("table");
      table.innerHTML = ""; // クリア

      board.forEach((row, i) => {
        const tr = document.createElement("tr");

        row.forEach((cell, j) => {
          const td = document.createElement("td");
          td.onclick = () => sendMove(i, j);

          // ここで className をセット
          if (cell === -1) {
            td.className = "black";
          } else if (cell === 1) {
            td.className = "white";
          } else {
            td.className = "";  // 空セル
          }

          tr.appendChild(td);
        });

        table.appendChild(tr);
      });
    }

  
      // 手番表示更新
      function updateTurnUI(turn) {
        const el = document.getElementById("currentTurn");
        el.innerText = turn === -1 ? "黒 ●" : "白 ○";
        el.style.color = turn === -1 ? "black" : "gray";
      }
  
      // サーバーに打ち手を送信
      async function sendMove(row, col) {
        const res = await fetch("/move", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ row, col })
        });
  
        const data = await res.json();
        if (data.status === "success" || data.status === "game_over") {
          // 盤面と手番を更新
          updateBoardUI(data.board);
          updateTurnUI(data.turn);
  
          if (data.passed) {
            alert("パスしました！");
          }
          if (data.status === "game_over") {
            alert(`ゲーム終了！ 白: ${data.score.white} vs 黒: ${data.score.black}`);
          }
        } else if (data.status === "cell occupied") {
          alert("すでに石が置かれています！");
        } else {
          alert("無効な手です");
        }
      }
  
      // サーバーリセット呼び出し
      async function resetBoard() {
        const res = await fetch("/reset", { method: "POST" });
        const data = await res.json();
        if (data.status === "reset") {
          // サーバー側で初期化された盤面と手番を取得し描画
          // （セッション上書き後、GET / で再描画でも OK）
          const resp = await fetch("/");
          const text = await resp.text();
          // シンプルにリロード
          window.location.reload();
        }
      }
  
      // 初期描画（ページロード時にサーバー描画済みなので DOM はすでに初期盤面）
      document.addEventListener("DOMContentLoaded", () => {
        // サーバー側で描画した初期盤面を再取得しておく場合は AJAX GET してもよいですが、
        // ここではそのまま現状の DOM を使います。
        // 以降の操作は sendMove/resetBoard を通じて反映されます。
      });
    </script>
  
</body>
</html>
